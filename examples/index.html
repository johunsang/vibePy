<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VibeWeb Examples</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            display: ["Urbanist", "sans-serif"],
            mono: ["Space Mono", "monospace"],
          },
          colors: {
            brand: {
              50: "#fff1ec",
              400: "#ff6b4a",
              600: "#f04f33",
            },
            mint: {
              400: "#1f9d8f",
            },
          },
        },
      },
    };
  </script>
</head>
<body class="min-h-screen bg-gradient-to-br from-[#f8f3ea] via-[#f1f6ff] to-[#e7fbf3] font-display text-slate-900">
  <div class="pointer-events-none fixed inset-0 -z-10 opacity-30 bg-[radial-gradient(rgba(15,23,42,0.08)_1px,transparent_1px)] [background-size:24px_24px]"></div>

  <main class="mx-auto flex max-w-6xl flex-col gap-8 px-6 py-10">
    <section class="rounded-[28px] border border-slate-900/10 bg-white/80 p-8 shadow-[0_18px_40px_rgba(15,23,42,0.12)] backdrop-blur">
      <div class="flex flex-wrap items-center justify-between gap-6">
        <div>
          <p class="text-[11px] uppercase tracking-[0.45em] text-slate-500">VibeWeb Gallery</p>
          <h1 class="mt-4 text-4xl font-semibold">Example Apps</h1>
          <p class="mt-3 max-w-xl text-sm text-slate-700">Syntax-first, JSON-only specs. Build, run, and extend with minimal glue.</p>
        </div>
        <div class="flex flex-col gap-2 rounded-2xl border border-slate-900/10 bg-brand-50 px-6 py-4 text-sm text-slate-700 shadow-[0_12px_24px_rgba(15,23,42,0.1)]">
          <span class="font-semibold">Default admin</span>
          <span class="rounded-full border border-slate-900 bg-brand-400 px-3 py-1 text-xs font-semibold text-slate-900">admin / admin</span>
        </div>
      </div>

      <div class="mt-6 flex flex-wrap items-center gap-3 text-xs text-slate-600">
        <span class="rounded-full border border-slate-900/10 bg-white/90 px-4 py-2 font-semibold shadow-[0_10px_18px_rgba(15,23,42,0.08)]">Tip: run with <span class="font-mono">--port 8001</span> to launch multiple apps.</span>
        <span class="rounded-full border border-slate-900/10 bg-white/90 px-4 py-2 font-semibold shadow-[0_10px_18px_rgba(15,23,42,0.08)]">All specs are pure JSON.</span>
      </div>
    </section>

    <section class="rounded-[28px] border border-slate-900/10 bg-white/90 p-8 shadow-[0_18px_40px_rgba(15,23,42,0.12)] backdrop-blur">
      <div class="flex flex-wrap items-center justify-between gap-4">
        <div>
          <p class="text-[11px] uppercase tracking-[0.45em] text-slate-500">Playground</p>
          <h2 class="mt-3 text-2xl font-semibold">Edit a spec, run locally</h2>
          <p class="mt-2 text-sm text-slate-700">Load a sample spec, tweak fields, then run the command below.</p>
        </div>
        <div class="rounded-2xl border border-slate-900/10 bg-brand-50 px-4 py-3 text-xs text-slate-700">
          JSON-only, CPython runtime
        </div>
      </div>

      <div class="mt-6 grid gap-6 lg:grid-cols-[1.2fr_0.8fr]">
        <div class="rounded-2xl border border-slate-900/10 bg-white p-4 shadow-[0_12px_24px_rgba(15,23,42,0.1)]">
          <div class="flex flex-wrap gap-2">
            <button class="rounded-full border border-slate-900/10 bg-brand-400 px-3 py-1 text-xs font-semibold text-white" data-sample="todo">Load Todo</button>
            <button class="rounded-full border border-slate-900/10 bg-white px-3 py-1 text-xs font-semibold text-slate-700" data-sample="crm">Load CRM</button>
            <button class="rounded-full border border-slate-900/10 bg-white px-3 py-1 text-xs font-semibold text-slate-700" data-sample="crm_advanced">Load CRM Advanced</button>
            <button class="rounded-full border border-slate-900/10 bg-white px-3 py-1 text-xs font-semibold text-slate-700" data-sample="inventory">Load Inventory</button>
          </div>
          <textarea id="playground-spec" rows="14" class="mt-4 w-full rounded-2xl border border-slate-900/10 bg-white px-4 py-3 font-mono text-xs shadow-[0_8px_16px_rgba(15,23,42,0.08)]"></textarea>
          <div class="mt-4 flex flex-wrap gap-2">
            <button id="copy-spec" class="rounded-full border border-slate-900/10 bg-white px-3 py-1 text-xs font-semibold text-slate-700">Copy JSON</button>
            <button id="download-spec" class="rounded-full border border-slate-900/10 bg-brand-400 px-3 py-1 text-xs font-semibold text-white">Download spec</button>
            <button id="format-spec" class="rounded-full border border-slate-900/10 bg-white px-3 py-1 text-xs font-semibold text-slate-700">Format</button>
            <button id="validate-spec" class="rounded-full border border-slate-900/10 bg-white px-3 py-1 text-xs font-semibold text-slate-700">Validate</button>
          </div>
          <p id="spec-status" class="mt-3 text-xs text-slate-600">Ready.</p>
        </div>

        <div class="flex flex-col gap-4">
          <div class="rounded-2xl border border-slate-900/10 bg-brand-50 p-5 shadow-[0_12px_24px_rgba(15,23,42,0.1)]">
            <h3 class="text-lg font-semibold">Run locally</h3>
            <p class="mt-2 text-xs text-slate-700">Start the app, then open the admin UI.</p>
            <pre id="run-command" class="mt-3 rounded-2xl border border-slate-900/10 bg-slate-900 px-4 py-3 font-mono text-[11px] text-slate-100">python3 -m vibeweb run examples/todo/todo.vweb.json --port 8000</pre>
            <button id="copy-command" class="mt-3 rounded-full border border-slate-900/10 bg-white px-3 py-1 text-xs font-semibold text-slate-700">Copy command</button>
            <p class="mt-4 text-xs text-slate-700">Then open <span class="font-mono">http://127.0.0.1:8000/admin</span></p>

            <div class="mt-6">
              <p class="text-xs text-slate-700">API quick test:</p>
              <pre class="mt-2 rounded-2xl border border-slate-900/10 bg-white px-3 py-2 font-mono text-[11px]">curl -s http://127.0.0.1:8000/api/Todo</pre>
          </div>
        </div>

          <div class="rounded-2xl border border-slate-900/10 bg-white p-5 shadow-[0_12px_24px_rgba(15,23,42,0.1)]">
            <h3 class="text-lg font-semibold">Quick Builder</h3>
            <p class="mt-1 text-xs text-slate-600">Generate a minimal CRUD app without writing JSON.</p>
            <div class="mt-3 grid gap-3">
              <label class="text-[11px] uppercase tracking-[0.2em] text-slate-500">App name
                <input id="qb-app-name" class="mt-2 w-full rounded-xl border border-slate-900/10 bg-white px-3 py-2 text-xs" placeholder="My App" />
              </label>
              <label class="text-[11px] uppercase tracking-[0.2em] text-slate-500">Model name
                <input id="qb-model-name" class="mt-2 w-full rounded-xl border border-slate-900/10 bg-white px-3 py-2 text-xs" placeholder="Item" />
              </label>
              <div>
                <p class="text-[11px] uppercase tracking-[0.2em] text-slate-500">Fields</p>
                <div id="qb-fields" class="mt-2 grid gap-2"></div>
                <div class="mt-2 flex flex-wrap gap-2">
                  <button id="qb-add-field" class="rounded-full border border-slate-900/10 bg-white px-3 py-1 text-xs font-semibold text-slate-700" type="button">Add field</button>
                  <button id="qb-generate" class="rounded-full border border-slate-900/10 bg-brand-400 px-3 py-1 text-xs font-semibold text-white" type="button">Generate spec</button>
                </div>
              </div>
            </div>
          </div>

          <div class="rounded-2xl border border-slate-900/10 bg-white p-5 shadow-[0_12px_24px_rgba(15,23,42,0.1)]">
            <h3 class="text-lg font-semibold">Spec summary</h3>
            <div id="spec-summary" class="mt-3 text-xs text-slate-700">
              <p>Load a spec to see models and pages.</p>
            </div>
          </div>

        </div>
      </div>
    </section>

    <section class="rounded-[28px] border border-slate-900/10 bg-white/90 p-8 shadow-[0_18px_40px_rgba(15,23,42,0.12)] backdrop-blur">
      <div class="flex flex-wrap items-center justify-between gap-4">
        <div>
          <p class="text-[11px] uppercase tracking-[0.45em] text-slate-500">Natural Language Builder</p>
          <h2 class="mt-3 text-2xl font-semibold">Generate a new app</h2>
          <p class="mt-2 text-sm text-slate-700">Powered by your configured OpenAI-compatible endpoint (recommended: local GLM-4.7-Flash). Describe the app and download a ZIP.</p>
        </div>
        <div class="rounded-2xl border border-slate-900/10 bg-brand-50 px-4 py-3 text-xs text-slate-700">
          Endpoint: <span class="font-mono">POST /generate</span>
        </div>
      </div>
      <form id="generate-form" class="mt-6 grid gap-4 md:grid-cols-[1fr_auto]" method="post" action="/generate">
        <textarea name="prompt" rows="4" class="w-full rounded-2xl border border-slate-900/10 bg-white px-4 py-3 text-sm shadow-[0_8px_16px_rgba(15,23,42,0.08)]" placeholder="예: CRM for freelancers with clients, projects, invoices"></textarea>
        <div class="flex flex-col gap-3">
          <button id="generate-btn" class="rounded-2xl border border-slate-900/10 bg-brand-400 px-6 py-3 text-sm font-semibold text-white shadow-[0_10px_18px_rgba(255,107,74,0.35)]" type="submit">Generate ZIP</button>
          <p id="generate-status" class="text-xs text-slate-600">Set `VIBEWEB_AI_BASE_URL` + `VIBEWEB_AI_MODEL` (and `VIBEWEB_AI_API_KEY` if required).</p>
        </div>
      </form>
    </section>

    <section class="grid gap-4 md:grid-cols-2">
      <article class="rounded-3xl border border-slate-900/10 bg-white p-6 shadow-[0_14px_28px_rgba(15,23,42,0.12)]">
        <h2 class="text-xl font-semibold">Todo</h2>
        <p class="mt-2 text-sm text-slate-700">Minimal CRUD starter.</p>
        <div class="mt-4 flex flex-wrap gap-3 text-sm">
          <a class="font-semibold text-slate-900 underline decoration-brand-400 decoration-4 underline-offset-4" href="./todo/todo.vweb.json">Spec file</a>
          <a class="text-slate-600" href="http://127.0.0.1:8000/admin" target="_blank" rel="noreferrer">Admin (run first)</a>
        </div>
        <pre class="mt-4 rounded-2xl border border-slate-900/10 bg-slate-900 px-4 py-3 font-mono text-xs text-slate-100">python3 -m vibeweb run examples/todo/todo.vweb.json</pre>
      </article>

      <article class="rounded-3xl border border-slate-900/10 bg-white p-6 shadow-[0_14px_28px_rgba(15,23,42,0.12)]">
        <h2 class="text-xl font-semibold">CRM</h2>
        <p class="mt-2 text-sm text-slate-700">Accounts, contacts, deals, activities.</p>
        <div class="mt-4 flex flex-wrap gap-3 text-sm">
          <a class="font-semibold text-slate-900 underline decoration-brand-400 decoration-4 underline-offset-4" href="./crm/crm.vweb.json">Spec file</a>
          <a class="text-slate-600" href="http://127.0.0.1:8000/admin" target="_blank" rel="noreferrer">Admin (run first)</a>
        </div>
        <pre class="mt-4 rounded-2xl border border-slate-900/10 bg-slate-900 px-4 py-3 font-mono text-xs text-slate-100">python3 -m vibeweb run examples/crm/crm.vweb.json</pre>
      </article>

      <article class="rounded-3xl border border-slate-900/10 bg-white p-6 shadow-[0_14px_28px_rgba(15,23,42,0.12)]">
        <h2 class="text-xl font-semibold">CRM Advanced</h2>
        <p class="mt-2 text-sm text-slate-700">Actions + hooks, LLM writeback, DB workflow hooks (when/when_changed), default filters/sort.</p>
        <div class="mt-4 flex flex-wrap gap-3 text-sm">
          <a class="font-semibold text-slate-900 underline decoration-brand-400 decoration-4 underline-offset-4" href="./crm/crm.advanced.vweb.json">Spec file</a>
          <a class="text-slate-600" href="http://127.0.0.1:8000/admin" target="_blank" rel="noreferrer">Admin (run first)</a>
        </div>
        <pre class="mt-4 rounded-2xl border border-slate-900/10 bg-slate-900 px-4 py-3 font-mono text-xs text-slate-100">python3 -m vibeweb run examples/crm/crm.advanced.vweb.json</pre>
      </article>

      <article class="rounded-3xl border border-slate-900/10 bg-white p-6 shadow-[0_14px_28px_rgba(15,23,42,0.12)]">
        <h2 class="text-xl font-semibold">Inventory</h2>
        <p class="mt-2 text-sm text-slate-700">Products, suppliers, orders.</p>
        <div class="mt-4 flex flex-wrap gap-3 text-sm">
          <a class="font-semibold text-slate-900 underline decoration-brand-400 decoration-4 underline-offset-4" href="./inventory/inventory.vweb.json">Spec file</a>
          <a class="text-slate-600" href="http://127.0.0.1:8000/admin" target="_blank" rel="noreferrer">Admin (run first)</a>
        </div>
        <pre class="mt-4 rounded-2xl border border-slate-900/10 bg-slate-900 px-4 py-3 font-mono text-xs text-slate-100">python3 -m vibeweb run examples/inventory/inventory.vweb.json</pre>
      </article>

      <article class="rounded-3xl border border-slate-900/10 bg-white p-6 shadow-[0_14px_28px_rgba(15,23,42,0.12)]">
        <h2 class="text-xl font-semibold">Shop</h2>
        <p class="mt-2 text-sm text-slate-700">Customers, products, orders.</p>
        <div class="mt-4 flex flex-wrap gap-3 text-sm">
          <a class="font-semibold text-slate-900 underline decoration-brand-400 decoration-4 underline-offset-4" href="./shop/shop.vweb.json">Spec file</a>
          <a class="text-slate-600" href="http://127.0.0.1:8000/admin" target="_blank" rel="noreferrer">Admin (run first)</a>
        </div>
        <pre class="mt-4 rounded-2xl border border-slate-900/10 bg-slate-900 px-4 py-3 font-mono text-xs text-slate-100">python3 -m vibeweb run examples/shop/shop.vweb.json</pre>
      </article>

      <article class="rounded-3xl border border-slate-900/10 bg-white p-6 shadow-[0_14px_28px_rgba(15,23,42,0.12)]">
        <h2 class="text-xl font-semibold">Healthcare</h2>
        <p class="mt-2 text-sm text-slate-700">Patients, appointments, visits.</p>
        <div class="mt-4 flex flex-wrap gap-3 text-sm">
          <a class="font-semibold text-slate-900 underline decoration-brand-400 decoration-4 underline-offset-4" href="./healthcare/healthcare.vweb.json">Spec file</a>
          <a class="text-slate-600" href="http://127.0.0.1:8000/admin" target="_blank" rel="noreferrer">Admin (run first)</a>
        </div>
        <pre class="mt-4 rounded-2xl border border-slate-900/10 bg-slate-900 px-4 py-3 font-mono text-xs text-slate-100">python3 -m vibeweb run examples/healthcare/healthcare.vweb.json</pre>
      </article>

      <article class="rounded-3xl border border-slate-900/10 bg-white p-6 shadow-[0_14px_28px_rgba(15,23,42,0.12)]">
        <h2 class="text-xl font-semibold">Education</h2>
        <p class="mt-2 text-sm text-slate-700">Courses, students, assignments.</p>
        <div class="mt-4 flex flex-wrap gap-3 text-sm">
          <a class="font-semibold text-slate-900 underline decoration-brand-400 decoration-4 underline-offset-4" href="./education/education.vweb.json">Spec file</a>
          <a class="text-slate-600" href="http://127.0.0.1:8000/admin" target="_blank" rel="noreferrer">Admin (run first)</a>
        </div>
        <pre class="mt-4 rounded-2xl border border-slate-900/10 bg-slate-900 px-4 py-3 font-mono text-xs text-slate-100">python3 -m vibeweb run examples/education/education.vweb.json</pre>
      </article>

      <article class="rounded-3xl border border-slate-900/10 bg-white p-6 shadow-[0_14px_28px_rgba(15,23,42,0.12)]">
        <h2 class="text-xl font-semibold">Real Estate</h2>
        <p class="mt-2 text-sm text-slate-700">Listings, agents, inquiries.</p>
        <div class="mt-4 flex flex-wrap gap-3 text-sm">
          <a class="font-semibold text-slate-900 underline decoration-brand-400 decoration-4 underline-offset-4" href="./realestate/realestate.vweb.json">Spec file</a>
          <a class="text-slate-600" href="http://127.0.0.1:8000/admin" target="_blank" rel="noreferrer">Admin (run first)</a>
        </div>
        <pre class="mt-4 rounded-2xl border border-slate-900/10 bg-slate-900 px-4 py-3 font-mono text-xs text-slate-100">python3 -m vibeweb run examples/realestate/realestate.vweb.json</pre>
      </article>

      <article class="rounded-3xl border border-slate-900/10 bg-white p-6 shadow-[0_14px_28px_rgba(15,23,42,0.12)]">
        <h2 class="text-xl font-semibold">Project Management</h2>
        <p class="mt-2 text-sm text-slate-700">Projects, tasks, team members.</p>
        <div class="mt-4 flex flex-wrap gap-3 text-sm">
          <a class="font-semibold text-slate-900 underline decoration-brand-400 decoration-4 underline-offset-4" href="./pm/pm.vweb.json">Spec file</a>
          <a class="text-slate-600" href="http://127.0.0.1:8000/admin" target="_blank" rel="noreferrer">Admin (run first)</a>
        </div>
        <pre class="mt-4 rounded-2xl border border-slate-900/10 bg-slate-900 px-4 py-3 font-mono text-xs text-slate-100">python3 -m vibeweb run examples/pm/pm.vweb.json</pre>
      </article>
    </section>

    <section class="rounded-3xl border border-slate-900/10 bg-white p-6 text-sm text-slate-700 shadow-[0_14px_28px_rgba(15,23,42,0.12)]">
      <div class="flex flex-wrap items-center justify-between gap-3">
        <span>Want to add more? Use <span class="font-mono">vibeweb ai</span> to generate new specs.</span>
        <span class="rounded-full border border-slate-900/10 bg-brand-50 px-3 py-1 font-mono text-xs">python3 -m vibeweb ai --prompt "..."</span>
      </div>
    </section>
  </main>

  <script>
    const samples = {
      todo: {
        label: "Todo",
        path: "./todo/todo.vweb.json",
        run: "python3 -m vibeweb run examples/todo/todo.vweb.json --port 8000"
      },
      crm: {
        label: "CRM",
        path: "./crm/crm.vweb.json",
        run: "python3 -m vibeweb run examples/crm/crm.vweb.json --port 8000"
      },
      crm_advanced: {
        label: "CRM Advanced",
        path: "./crm/crm.advanced.vweb.json",
        run: "python3 -m vibeweb run examples/crm/crm.advanced.vweb.json --port 8000"
      },
      inventory: {
        label: "Inventory",
        path: "./inventory/inventory.vweb.json",
        run: "python3 -m vibeweb run examples/inventory/inventory.vweb.json --port 8000"
      }
    };

    const specArea = document.getElementById("playground-spec");
    const runCommand = document.getElementById("run-command");
    const copySpecBtn = document.getElementById("copy-spec");
    const copyCmdBtn = document.getElementById("copy-command");
    const downloadBtn = document.getElementById("download-spec");
    const formatBtn = document.getElementById("format-spec");
    const validateBtn = document.getElementById("validate-spec");
    const statusEl = document.getElementById("spec-status");
    const summaryEl = document.getElementById("spec-summary");
    const qbAppName = document.getElementById("qb-app-name");
    const qbModelName = document.getElementById("qb-model-name");
    const qbFields = document.getElementById("qb-fields");
    const qbAddField = document.getElementById("qb-add-field");
    const qbGenerate = document.getElementById("qb-generate");
    const generateForm = document.getElementById("generate-form");
    const generateBtn = document.getElementById("generate-btn");
    const generateStatus = document.getElementById("generate-status");
    const generateIdleText = generateStatus.textContent;

    function escapeHtml(value) {
      return String(value)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;");
    }

    function setStatus(message, ok = true) {
      statusEl.textContent = message;
      statusEl.className = ok
        ? "mt-3 text-xs text-emerald-700"
        : "mt-3 text-xs text-rose-600";
    }

    function renderSummary(spec) {
      if (!spec || typeof spec !== "object") {
        summaryEl.innerHTML = "<p>Invalid spec.</p>";
        return;
      }
      const models = spec.db?.models || [];
      const pages = spec.ui?.pages || [];
      const adminEnabled = !!spec.ui?.admin;
      const modelLines = models.map((m) => {
        const fields = Object.keys(m.fields || {}).join(", ");
        return `<li><span class="font-semibold">${escapeHtml(m.name || "Model")}</span>: ${escapeHtml(fields || "no fields")}</li>`;
      });
      summaryEl.innerHTML = `
        <p><span class="font-semibold">Models:</span> ${models.length}</p>
        <ul class="mt-2 flex list-disc flex-col gap-1 pl-4 text-[11px]">${modelLines.join("")}</ul>
        <p class="mt-3"><span class="font-semibold">Pages:</span> ${pages.length}</p>
        <p class="mt-1"><span class="font-semibold">Admin:</span> ${adminEnabled ? "enabled" : "disabled"}</p>
      `;
    }

    function parseSpec() {
      const raw = specArea.value.trim();
      if (!raw) {
        setStatus("Spec is empty.", false);
        summaryEl.innerHTML = "<p>Load a spec to see models and pages.</p>";
        return null;
      }
      try {
        const spec = JSON.parse(raw);
        const errors = [];
        if (!spec.name) errors.push("Missing name");
        if (!spec.db || !Array.isArray(spec.db.models)) errors.push("Missing db.models");
        if (!spec.api || !Array.isArray(spec.api.crud)) errors.push("Missing api.crud");
        if (!spec.ui || !Array.isArray(spec.ui.pages)) errors.push("Missing ui.pages");
        if (errors.length) {
          setStatus("Valid JSON, but incomplete spec: " + errors.join(", "), false);
        } else {
          setStatus("Valid JSON spec.");
        }
        renderSummary(spec);
        return spec;
      } catch (err) {
        setStatus("Invalid JSON: " + err.message, false);
        summaryEl.innerHTML = "<p>Fix JSON to see summary.</p>";
        return null;
      }
    }

    function slugify(value) {
      return String(value || "")
        .toLowerCase()
        .trim()
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/^-+|-+$/g, "") || "vibeweb-app";
    }

    function createFieldRow(name = "", type = "text") {
      const row = document.createElement("div");
      row.className = "flex items-center gap-2";
      const input = document.createElement("input");
      input.placeholder = "field_name";
      input.value = name;
      input.className = "flex-1 rounded-lg border border-slate-900/10 bg-white px-2 py-1 text-xs";
      const select = document.createElement("select");
      select.className = "rounded-lg border border-slate-900/10 bg-white px-2 py-1 text-xs";
      ["text", "int", "float", "bool", "datetime", "json"].forEach((t) => {
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        if (t === type) opt.selected = true;
        select.appendChild(opt);
      });
      const remove = document.createElement("button");
      remove.type = "button";
      remove.textContent = "Remove";
      remove.className = "rounded-full border border-slate-900/10 bg-white px-2 py-1 text-[10px] font-semibold text-slate-600";
      remove.addEventListener("click", () => row.remove());
      row.appendChild(input);
      row.appendChild(select);
      row.appendChild(remove);
      return row;
    }

    function collectFields() {
      const fields = {};
      qbFields.querySelectorAll("div").forEach((row) => {
        const input = row.querySelector("input");
        const select = row.querySelector("select");
        if (!input || !select) return;
        const name = input.value.trim();
        const type = select.value;
        if (name) fields[name] = type;
      });
      if (Object.keys(fields).length === 0) {
        fields["name"] = "text";
      }
      return fields;
    }

    function generateSpecFromBuilder() {
      const appName = qbAppName.value.trim() || "My App";
      const modelName = qbModelName.value.trim() || "Item";
      const fields = collectFields();
      const spec = {
        name: appName,
        db: {
          path: `${slugify(appName)}.db`,
          models: [{ name: modelName, fields }]
        },
        api: { crud: [modelName] },
        ui: {
          admin: true,
          admin_path: "/admin",
          admin_auth: { type: "basic", username: "admin", password: "admin" },
          pages: [{ path: "/", model: modelName, title: `${modelName} List` }]
        }
      };
      specArea.value = JSON.stringify(spec, null, 2);
      runCommand.textContent = "python3 -m vibeweb run app.vweb.json --port 8000";
      setStatus("Spec generated from Quick Builder.");
      parseSpec();
    }

    async function loadSample(name) {
      const sample = samples[name];
      if (!sample) return;
      try {
        const res = await fetch(sample.path);
        if (!res.ok) throw new Error("Failed to load spec");
        const text = await res.text();
        specArea.value = text.trim();
        runCommand.textContent = sample.run;
        parseSpec();
      } catch (err) {
        specArea.value = "// Failed to load sample. Check server or path.";
        setStatus("Failed to load sample.", false);
      }
    }

    function copyText(text) {
      if (navigator.clipboard?.writeText) {
        navigator.clipboard.writeText(text);
        return;
      }
      const temp = document.createElement("textarea");
      temp.value = text;
      document.body.appendChild(temp);
      temp.select();
      document.execCommand("copy");
      document.body.removeChild(temp);
    }

    document.querySelectorAll("[data-sample]").forEach((btn) => {
      btn.addEventListener("click", () => loadSample(btn.dataset.sample));
    });

    copySpecBtn.addEventListener("click", () => {
      copyText(specArea.value);
    });

    copyCmdBtn.addEventListener("click", () => {
      copyText(runCommand.textContent);
    });

    downloadBtn.addEventListener("click", () => {
      const blob = new Blob([specArea.value], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "app.vweb.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    formatBtn.addEventListener("click", () => {
      const spec = parseSpec();
      if (!spec) return;
      specArea.value = JSON.stringify(spec, null, 2);
      setStatus("Formatted JSON.");
    });

    validateBtn.addEventListener("click", () => {
      parseSpec();
    });

    let debounce;
    specArea.addEventListener("input", () => {
      window.clearTimeout(debounce);
      debounce = window.setTimeout(() => {
        parseSpec();
      }, 400);
    });

    qbAddField.addEventListener("click", () => {
      qbFields.appendChild(createFieldRow());
    });

    qbGenerate.addEventListener("click", () => {
      generateSpecFromBuilder();
    });

    qbAppName.value = "Quick App";
    qbModelName.value = "Item";
    qbFields.appendChild(createFieldRow("name", "text"));

    loadSample("todo");

    generateForm.addEventListener("submit", async (event) => {
      event.preventDefault();
      const prompt = String(
        generateForm.querySelector('[name="prompt"]')?.value || ""
      ).trim();
      if (!prompt) {
        generateStatus.textContent = "프롬프트를 입력하세요.";
        return;
      }
      generateBtn.disabled = true;
      generateBtn.textContent = "생성중...";
      generateStatus.textContent = "생성중...";
      try {
        const res = await fetch("/generate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt }),
        });
        if (!res.ok) {
          const contentType = String(res.headers.get("Content-Type") || "").toLowerCase();
          let text = "";
          try {
            text = await res.text();
          } catch {}
          const trimmed = String(text || "").trim();
          const looksLikeHtml = trimmed.toLowerCase().includes("<!doctype html") || trimmed.toLowerCase().includes("<html");
          const looksLikePlainError = contentType.includes("text/plain") && trimmed && trimmed.length < 400;
          const message = looksLikePlainError && !looksLikeHtml
            ? trimmed.split("\n")[0]
            : `${res.status} ${res.statusText || "Error"}`;
          throw new Error(message);
        }
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "vibeweb-app.zip";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        generateStatus.textContent = "완료: ZIP 다운로드됨.";
      } catch (err) {
        generateStatus.textContent = `실패: ${err.message || "Generation failed."}`;
      } finally {
        generateBtn.disabled = false;
        generateBtn.textContent = "Generate ZIP";
        if (generateStatus.textContent === "생성중...") {
          generateStatus.textContent = generateIdleText;
        }
      }
    });
  </script>
</body>
</html>
